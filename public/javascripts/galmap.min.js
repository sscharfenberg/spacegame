/*!***************************************************************************************
** Project: game v0.0.1 - turn-based space game 
** Author: Sven Scharfenberg (sven.scharfenberg@projektvier.de) 
** Last Changes: 18.11.2013 17:53 
** Homepage: tbd 
** License: GNU General Public License 3.0 (http://www.gnu.org/licenses/gpl-3.0.en.html) 
*****************************************************************************************/

window.galmap=window.galmap||{tilesize:0,mapdata:null,init:function(){if((!Modernizr.canvas)||(!Modernizr.canvastext)){alert("Sorry, your browser does not support canvas or canvastext. Please update your browser");location.href="http://www.google.de/intl/de/chrome/browser/"}var b=$("#mapViewPort"),c=$("#viewPortRulerVert");b.height(b.width()).height(b.width());c.height(b.height());var a=galmap.loadData("./mapdata.json");a.done(function(d){utils.log("Data recieved from JSON",d);galmap.mapdata=d;galmap.setInitialZoom();galmap.drawMap(d);galmap.setInitialCoords();galmap.bindMapDragging();galmap.bindRulerDragging();galmap.bindFocusButton(".mapbutton.focushome",d.systems[d.home].x,d.systems[d.home].y);galmap.bindZoom();$(".overlay.loading").hide();utils.log("finished drawing map!")}).fail(function(d){utils.log("faled to recieve data from JSON",d);$(".overlay.jsonfail").show();galmap.bindRefreshButton()})},loadData:function(a){$(".overlay.loading").show();return $.getJSON(a)},setInitialZoom:function(){var b=$("#currentZoomMarker"),a;if((Modernizr.localstorage)&&(localStorage["galmap.zoomlevel"])){a=parseInt(b.find("span").length,10)-parseInt(localStorage["galmap.zoomlevel"],10)-1}else{a=Math.ceil(parseInt(b.find("span").length-1,10)/2)}galmap.tilesize=parseInt(b.find("span").eq(a).addClass("active").text(),10);if(b.find("span:first").hasClass("active")){$(".icon.in").addClass("disabled")}if(b.find("span:last").hasClass("active")){$(".icon.out").addClass("disabled")}},setInitialCoords:function(){if((Modernizr.localstorage)&&(localStorage["galmap.coords.x"])&&(localStorage["galmap.coords.y"])){var b=parseInt(localStorage["galmap.coords.x"],10),a=parseInt(localStorage["galmap.coords.y"],10),e=galmap.getOffSetFromCoords(b,a),d=e.x,c=e.y;$("#rulerHorzCanvas").css("left",d);$("#rulerVertCanvas").css("top",c);$("#mapCanvas").css({left:d,top:c});utils.log("coords from localstorage: ("+b+","+a+"); moving map to ("+d+","+c+")")}},drawMap:function(c){var b=$("#mapCanvas");var a=galmap.tilesize*c.settings.size;b.prop({width:a,height:a});b.clearCanvas({x:0,y:0,width:a,height:a}).removeLayers();galmap.drawGrid(c.settings.size);galmap.drawRulers(c.settings.size);utils.log("Number of Wormholes: "+c.wormholes.length);c.wormholes.forEach(function(d){galmap.drawWormHole(d.from,d.to)});utils.log("Number of Systems: "+c.systems.length);c.systems.forEach(function(d){galmap.drawSystem(d.id)})},drawGrid:function(){var g=$("#mapCanvas"),d="#1a1a1a",h=2,c,b,f,e;if(galmap.tilesize<50){h=1}for(var a=0;a<(galmap.mapdata.settings.size-1);a++){c=(galmap.tilesize*a)+galmap.tilesize;b=(galmap.tilesize*a)+galmap.tilesize;f=0;e=g.height();g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:h,x1:c,y1:f,x2:b,y2:e});c=0;b=g.width();f=(galmap.tilesize*a)+galmap.tilesize;e=(galmap.tilesize*a)+galmap.tilesize;g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:h,x1:c,y1:f,x2:b,y2:e})}g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:h,x1:1,y1:1,x2:g.width()-1,y2:1,x3:g.width()-1,y3:g.height()-1,x4:1,y4:g.height()-1,x5:1,y5:1});utils.log("finished drawing grid")},drawRulers:function(){var e=$("#rulerHorzCanvas"),d=$("#rulerVertCanvas"),g="#fff",c="#1a1a1a",h=2,b=galmap.tilesize*galmap.mapdata.settings.size,f;if(galmap.tilesize<50){h=1}e.prop({width:b});d.prop({height:b});for(var a=0;a<galmap.mapdata.settings.size;a++){f=a.toString();e.drawText({fontSize:12,fontFamily:"Arial",fillStyle:g,x:Math.round((galmap.tilesize*a)+(galmap.tilesize/2)),y:12,text:f}).drawLine({strokeStyle:c,strokeWidth:h,x1:(galmap.tilesize*a)+galmap.tilesize,y1:0,x2:(galmap.tilesize*a)+galmap.tilesize,y2:e.height()});d.drawText({fontSize:12,fontFamily:"Arial",fillStyle:g,x:12,y:Math.round((galmap.tilesize*a)+(galmap.tilesize/2)),text:f}).drawLine({strokeStyle:c,strokeWidth:h,x1:0,y1:(galmap.tilesize*a)+galmap.tilesize,x2:d.width(),y2:(galmap.tilesize*a)+galmap.tilesize})}e.drawLine({strokeStyle:c,strokeWidth:2,x1:e.width(),y1:e.height(),x2:0,y2:e.height(),x3:0,y3:0,x4:e.width(),y4:0});d.drawLine({strokeStyle:c,strokeWidth:2,x1:0,y1:d.height(),x2:0,y2:0,x3:d.width(),y3:0,x4:d.width(),y4:d.height()});utils.log("finished drawing rulers")},bindRefreshButton:function(){var b=$(".overlay.jsonfail"),a=b.find("a.refresh");utils.log("binding refresh button");$(document).on("click",a,function(c){c.preventDefault();b.hide();utils.log("refresh initiated by user",b);galmap.init()})},bindMapDragging:function(){var a=$("#mapCanvas"),b=$("#mapViewPort");a.drag(function(f,c){var e=parseInt(a.prop("width")-b.width(),10),d=parseInt(a.prop("height")-b.height(),10);if(c.offsetY>0){c.offsetY=0}if(c.offsetY<-d){c.offsetY=-d}if(c.offsetX>0){c.offsetX=0}if(c.offsetX<-e){c.offsetX=-e}$(this).css({top:c.offsetY,left:c.offsetX});$("#rulerHorzCanvas").css("left",c.offsetX);$("#rulerVertCanvas").css("top",c.offsetY)},{relative:true}).drag("end",function(){utils.log("dragged map to ... top: "+$(this).css("top")+", left: "+$(this).css("left"));galmap.saveCurrentCoords($(this).css("top"),$(this).css("left"))})},saveCurrentCoords:function(e,c){if(Modernizr.localstorage){var d=galmap.getCoordsFromOffset(Math.abs(parseInt(c,10)),Math.abs(parseInt(e,10))),b=d.x,a=d.y;localStorage["galmap.coords.x"]=b;localStorage["galmap.coords.y"]=a;utils.log("saved coordinates to localstorage - x:"+b+", y:"+a)}else{utils.log("localStorage not supported, not saving.")}},bindRulerDragging:function(){var e=$("#mapCanvas"),f=$("#mapViewPort"),d=$("#rulerHorzCanvas"),c=$("#rulerVertCanvas"),b,a;d.drag(function(h,g){b=parseInt(e.prop("width")-f.width(),10);if(g.offsetX>0){g.offsetX=0}if(g.offsetX<-b){g.offsetX=-b}$(this).css({left:g.offsetX});e.css("left",g.offsetX)},{relative:true}).drag("end",function(){utils.log("dragged horizontal ruler","endposition - left: "+d.css("left"))});c.drag(function(h,g){a=parseInt(e.prop("height")-f.height(),10);if(g.offsetY>0){g.offsetY=0}if(g.offsetY<-a){g.offsetY=-a}$(this).css({top:g.offsetY});e.css("top",g.offsetY)},{relative:true}).drag("end",function(){utils.log("dragged vertical ruler","endposition -  top: "+c.css("top"))})},bindFocusButton:function(b,c,a){$(document).on("click",b,function(d){d.preventDefault();galmap.focusMap(c,a,true)})},focusMap:function(j,h,d){var e=$("#mapViewPort"),a=$("#mapCanvas"),c=galmap.getOffSetFromCoords(j,h),i=c.x,g=c.y,b=parseInt(a.prop("width")-e.width(),10),f=parseInt(a.prop("height")-e.height(),10);if(i<-b){i=-f}if(g<-f){g=-f}if(i>0){i=0}if(g>0){g=0}if(d){utils.log("moving map and rulers to ... x: "+i+", y:"+g+" ("+j+","+h+")");$("#rulerHorzCanvas").animate({left:i},200);$("#rulerVertCanvas").animate({top:g},20);a.animate({left:i,top:g},200,function(){a.removeLayerGroup("flashbg").removeLayerGroup("flashtile");var k="#153b61",l="#9cf";a.drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*j)-1,y:0,width:galmap.tilesize+2,height:(galmap.tilesize*h)}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*j)-1,y:(galmap.tilesize*(h+1)),width:galmap.tilesize+2,height:a.height()-(galmap.tilesize*h)}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:0,y:(galmap.tilesize*h)-1,width:(galmap.tilesize*j),height:galmap.tilesize+2}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*(j+1)),y:(galmap.tilesize*h)-1,width:a.width()-(galmap.tilesize*j),height:galmap.tilesize+2}).drawRect({fillStyle:"transparent",strokeStyle:l,strokeWidth:2,layer:true,fromCenter:false,groups:["flashtile"],x:(galmap.tilesize*j),y:(galmap.tilesize*h),width:galmap.tilesize,height:galmap.tilesize});a.animateLayerGroup("flashbg",{fillStyle:"transparent"},1500,"swing",function(m){a.removeLayerGroup(m)});a.animateLayerGroup("flashtile",{strokeStyle:"transparent"},1500,"swing",function(m){a.removeLayerGroup(m)});a.drawLayers()})}else{utils.log("snapping map and rulers to ... x: "+i+", y:"+g+" ("+j+","+h+")");$("#rulerHorzCanvas").css("left",i);$("#rulerVertCanvas").css("top",g);a.css({left:i,top:g})}},bindZoom:function(){$(document).on("click",".zoom a.icon:not(.disabled)",function(c){c.preventDefault();utils.log("zoom requested");var b=$("#currentZoomMarker"),e=$("#mapCanvas"),a=e.position(),d=galmap.getCoordsFromOffset(a.left,a.top),g=d.x,f=d.y;utils.log("coordinates before zooming: ("+g+","+f+")");if($(this).hasClass("in")){if(b.find("span.active").next("span").length===0){$(".icon.out").removeClass("disabled")}if(b.find("span.active").prev("span").length>0){b.find("span.active").removeClass("active").prev("span").addClass("active")}if(b.find("span.active").prev("span").length===0){$(this).addClass("disabled")}galmap.tilesize=parseInt(b.find("span.active").text(),10);utils.log("new tilesize: "+galmap.tilesize);galmap.drawMap(galmap.mapdata);galmap.focusMap(g,f);if(Modernizr.localstorage){localStorage["galmap.zoomlevel"]=parseInt(b.find("span").length,10)-b.find("span.active").index()-1;localStorage["galmap.coords.x"]=g;localStorage["galmap.coords.y"]=f}}else{if($(this).hasClass("out")){if(b.find("span.active").prev("span").length===0){$(".icon.in").removeClass("disabled")}if(b.find("span.active").next("span").length>0){b.find("span.active").removeClass("active").next("span").addClass("active")}if(b.find("span.active").next("span").length===0){$(this).addClass("disabled")}galmap.tilesize=parseInt(b.find("span.active").text(),10);utils.log("new tilesize"+galmap.tilesize);galmap.drawMap(galmap.mapdata);galmap.focusMap(g,f);if(Modernizr.localstorage){localStorage["galmap.zoomlevel"]=parseInt(b.find("span").length,10)-b.find("span.active").index()-1;localStorage["galmap.coords.x"]=g;localStorage["galmap.coords.y"]=f}}}})},getCoordsFromOffset:function(d,b){var f=$("#mapCanvas"),g=$("#mapViewPort"),e=Math.abs(((g.width()/f.width())*galmap.mapdata.settings.size)/2),c=parseInt((Math.ceil(Math.abs((d/f.width())*galmap.mapdata.settings.size)+e)-1),10),a=parseInt((Math.ceil(Math.abs((b/f.height())*galmap.mapdata.settings.size)+e)-1),10);return{x:c,y:a}},getOffSetFromCoords:function(i,g){var a=$("#mapViewPort"),e=Math.round(a.width()/2),c=Math.round(a.height()/2),d=Math.round(((i+1)*galmap.tilesize)-(galmap.tilesize/2)),b=Math.round(((g+1)*galmap.tilesize)-(galmap.tilesize/2)),h=e-d,f=c-b;return{x:h,y:f}},drawSystem:function(h){var c=galmap.mapdata.systems[h].x,a=galmap.mapdata.systems[h].y,f=$("#mapCanvas"),e=64,d=(c*galmap.tilesize)+Math.round(galmap.tilesize/2),b=(a*galmap.tilesize)+Math.round(galmap.tilesize/2),g=Math.round((galmap.tilesize*4)/5);utils.log("drawing system - id: "+h+", owner: "+galmap.mapdata.systems[h].owner+", spectral: "+galmap.mapdata.systems[h].spectral+", x: "+c+"("+d+"), y: "+a+"("+b+")");f.drawImage({source:$("#spriteStars").prop("src"),sWidth:e,sHeight:e,sx:0,sy:(galmap.mapdata.systems[h].spectral*e),cropFromCenter:false,layer:true,clickable:true,name:"system-"+h,groups:["systems"],x:d,y:b,width:g,height:g,fromCenter:true,mouseover:function(){f.css("cursor","pointer")},mouseout:function(){$(this).css("cursor","move")},click:function(){utils.log("clicked on star - id: "+h+", owner: "+galmap.mapdata.systems[h].owner+", spectral: "+galmap.mapdata.systems[h].spectral)}})},drawWormHole:function(g,f){var a="#9cf",e=(galmap.mapdata.systems[g].x*galmap.tilesize)+(galmap.tilesize/2),c=(galmap.mapdata.systems[g].y*galmap.tilesize)+(galmap.tilesize/2),d=(galmap.mapdata.systems[f].x*galmap.tilesize)+(galmap.tilesize/2),b=(galmap.mapdata.systems[f].y*galmap.tilesize)+(galmap.tilesize/2);strokeWidth=1;if(galmap.tilesize>50){strokeWidth=2}utils.log("drawing wormhole from #"+g+" ("+e+","+c+") to #"+f+" ("+d+","+b+")");$("#mapCanvas").drawLine({layer:true,groups:["wormholes"],strokeStyle:a,strokeWidth:strokeWidth,x1:e,y1:c,x2:d,y2:b})}};galmap.init();