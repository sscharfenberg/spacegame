/*!***************************************************************************************
** Project: game v0.0.1 - turn-based space game 
** Author: Sven Scharfenberg (sven.scharfenberg@projektvier.de) 
** Last Changes: 17.11.2013 00:46 
** Homepage: tbd 
** License: GNU General Public License 3.0 (http://www.gnu.org/licenses/gpl-3.0.en.html) 
*****************************************************************************************/

window.galmap=window.galmap||{tilesize:50,mapdata:null,init:function(){if((!Modernizr.canvas)||(!Modernizr.canvastext)){alert("Sorry, your browser does not support canvas or canvastext. Please update your browser");location.href="http://www.google.de/intl/de/chrome/browser/"}var b=$("#mapViewPort");var c=$("#viewPortRulerVert");b.height(b.width()).height(b.width());c.height(b.width());var a=galmap.loadData("./mapdata.json");a.done(function(d){game.log("Data recieved from JSON",d);galmap.mapdata=d;galmap.drawMap(d);galmap.bindMapDragging();galmap.bindRulerDragging();galmap.bindFocusButton(".mapbutton.focushome",d.systems[d.home].x,d.systems[d.home].y);galmap.bindZoom();$(".overlay.loading").hide();game.log("finished drawing map",0)}).fail(function(d){game.log("faled to recieve data from JSON",d);$(".overlay.jsonfail").show();galmap.bindRefreshButton()})},loadData:function(a){$(".overlay.loading").show();return $.getJSON(a)},drawMap:function(c){var b=$("#mapCanvas");var a=galmap.tilesize*c.settings.size;b.attr({width:a,height:a});b.clearCanvas({x:0,y:0,width:a,height:a}).removeLayers();galmap.drawGrid(c.settings.size);galmap.drawRulers(c.settings.size);game.log("Number of Wormholes",c.wormholes.length);c.wormholes.forEach(function(d){galmap.drawWormHole(d.from,d.to)});game.log("Number of Systems",c.systems.length);c.systems.forEach(function(d){galmap.drawSystem(d.id)})},drawGrid:function(){var g=$("#mapCanvas");var d="#1a1a1a";var c,b,f,e=0;for(var a=0;a<(galmap.mapdata.settings.size-1);a++){c=(galmap.tilesize*a)+galmap.tilesize;b=(galmap.tilesize*a)+galmap.tilesize;f=0;e=g.height();g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:2,x1:c,y1:f,x2:b,y2:e});c=0;b=g.width();f=(galmap.tilesize*a)+galmap.tilesize;e=(galmap.tilesize*a)+galmap.tilesize;g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:2,x1:c,y1:f,x2:b,y2:e})}g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:2,x1:1,y1:1,x2:g.width()-1,y2:1,x3:g.width()-1,y3:g.height()-1,x4:1,y4:g.height()-1,x5:1,y5:1});game.log("finished drawing grid",0)},drawRulers:function(){var f=$("#rulerHorzCanvas");var g=$("#rulerVertCanvas");var n="#fff";var m="#1a1a1a";var c,a,k,j,e,d=0;var l=null;var b=galmap.tilesize*galmap.mapdata.settings.size;f.attr({width:b});g.attr({height:b});for(var h=0;h<galmap.mapdata.settings.size;h++){l=h.toString();c=Math.round((galmap.tilesize*h)+(galmap.tilesize/2));a=12;k=(galmap.tilesize*h)+galmap.tilesize;e=0;j=(galmap.tilesize*h)+galmap.tilesize;d=f.height();f.drawText({fontSize:12,fontFamily:"Arial",fillStyle:n,x:c,y:a,text:l}).drawLine({strokeStyle:m,strokeWidth:2,x1:k,y1:e,x2:j,y2:d});c=12;a=Math.round((galmap.tilesize*h)+(galmap.tilesize/2));k=0;e=(galmap.tilesize*h)+galmap.tilesize;j=g.width();d=(galmap.tilesize*h)+galmap.tilesize;g.drawText({fontSize:12,fontFamily:"Arial",fillStyle:n,x:c,y:a,text:l}).drawLine({strokeStyle:m,strokeWidth:2,x1:k,y1:e,x2:j,y2:d})}f.drawLine({strokeStyle:m,strokeWidth:2,x1:f.width(),y1:f.height(),x2:0,y2:f.height(),x3:0,y3:0,x4:f.width(),y4:0});g.drawLine({strokeStyle:m,strokeWidth:2,x1:0,y1:g.height(),x2:0,y2:0,x3:g.width(),y3:0,x4:g.width(),y4:g.height()});game.log("finished drawing rulers",0)},bindRefreshButton:function(){var b=$(".overlay.jsonfail");var a=b.find("a.refresh");game.log("refreshbutton",a);$(document).on("click",a,function(c){c.preventDefault();b.hide();game.log("refresh initiated by user",b);galmap.init()})},bindMapDragging:function(){var a=$("#mapCanvas");var b=$("#mapViewPort");a.draggable({drag:function(e,f){var d=parseInt(a.attr("width")-b.width(),10);var c=parseInt(a.attr("height")-b.height(),10);if(f.position.top>0){f.position.top=0}if(f.position.top<-c){f.position.top=-c}if(f.position.left>0){f.position.left=0}if(f.position.left<-d){f.position.left=-d}if((f.position.top<=0)&&(f.position.left<=0)&&(f.position.left>=-d)&&(f.position.top>=-c)){$("#rulerHorzCanvas").css("left",f.position.left);$("#rulerVertCanvas").css("top",f.position.top)}},stop:function(c,d){game.log("dragged map","position - top: "+d.position.top+", left: "+d.position.left+" // originalPosition - top: "+d.originalPosition.top+", left: "+d.originalPosition.left)}})},bindRulerDragging:function(){var e=$("#mapCanvas");var f=$("#mapViewPort");var d=$("#rulerHorzCanvas");var c=$("#rulerVertCanvas");var b=parseInt(e.attr("width")-f.width(),10);var a=parseInt(e.attr("height")-f.height(),10);d.draggable({axis:"x",drag:function(g,h){if(h.position.left>0){h.position.left=0}if(h.position.left<-b){h.position.left=-b}if((h.position.left<=0)&&(h.position.left>=-b)){e.css("left",h.position.left)}},stop:function(g,h){game.log("dragged horizontal ruler","position - top: "+h.position.top+", left: "+h.position.left+" // originalPosition - top: "+h.originalPosition.top+", left: "+h.originalPosition.left)}});c.draggable({axis:"y",drag:function(g,h){if(h.position.top>0){h.position.top=0}if(h.position.top<-a){h.position.top=-a}if((h.position.top<=0)&&(h.position.top>=-a)){e.css("top",h.position.top)}},stop:function(g,h){game.log("dragged vertical ruler","position - top: "+h.position.top+", left: "+h.position.left+" // originalPosition - top: "+h.originalPosition.top+", left: "+h.originalPosition.left)}})},bindFocusButton:function(b,c,a){$(document).on("click",b,function(d){d.preventDefault();galmap.focusMap(c,a,"flash")})},focusMap:function(j,h,f){var d=$("#mapViewPort");var a=$("#mapCanvas");var c=galmap.getOffSetFromCoords(j,h);var i=c.x;var g=c.y;var b=parseInt(a.attr("width")-d.width(),10);var e=parseInt(a.attr("height")-d.height(),10);if(i<-b){i=-e}if(g<-e){g=-e}if(i>0){i=0}if(g>0){g=0}if(f==="flash"){game.log("moving map and rulers to","x: "+i+", y:"+g+" ("+j+","+h+")");$("#rulerHorzCanvas").animate({left:i},100);$("#rulerVertCanvas").animate({top:g},100);a.animate({left:i,top:g},100,function(){a.removeLayerGroup("flashbg").removeLayerGroup("flashtile");var k="#153b61",l="#9cf";a.drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*j)-1,y:0,width:galmap.tilesize+2,height:(galmap.tilesize*h)}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*j)-1,y:(galmap.tilesize*(h+1)),width:galmap.tilesize+2,height:a.height()-(galmap.tilesize*h)}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:0,y:(galmap.tilesize*h)-1,width:(galmap.tilesize*j),height:galmap.tilesize+2}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*(j+1)),y:(galmap.tilesize*h)-1,width:a.width()-(galmap.tilesize*j),height:galmap.tilesize+2}).drawRect({fillStyle:"transparent",strokeStyle:l,strokeWidth:2,layer:true,fromCenter:false,groups:["flashtile"],x:(galmap.tilesize*j),y:(galmap.tilesize*h),width:galmap.tilesize,height:galmap.tilesize});a.animateLayerGroup("flashbg",{fillStyle:"transparent"},1500,"swing",function(m){a.removeLayerGroup(m)});a.animateLayerGroup("flashtile",{strokeStyle:"transparent"},1500,"swing",function(m){a.removeLayerGroup(m)});a.drawLayers()})}else{game.log("snapping map and rulers to","x: "+i+", y:"+g+" ("+j+","+h+")");$("#rulerHorzCanvas").css("left",i);$("#rulerVertCanvas").css("top",g);a.css({left:i,top:g})}},bindZoom:function(){$(".zoom a.icon").click(function(c){c.preventDefault();if(!$(this).hasClass("disabled")){game.log("Zoom requested",0);var b=$("#currentZoomMarker");var e=$("#mapCanvas");var a=e.position();var d=galmap.getCoordsFromOffset(a.left,a.top);var g=d.x;var f=d.y;game.log("Coordinates before bindZoom","("+g+","+f+")");if($(this).hasClass("in")){if(b.find("span.active").prev("span").length===0){$(".icon.out").removeClass("disabled")}if(b.find("span.active").next("span").length>0){b.find("span.active").removeClass("active").next("span").addClass("active")}if(b.find("span.active").next("span").length===0){$(this).addClass("disabled")}galmap.tilesize=parseInt(b.find("span.active").text(),10);game.log("new tilesize",galmap.tilesize);galmap.drawMap(galmap.mapdata);galmap.focusMap(g,f)}else{if($(this).hasClass("out")){if(b.find("span.active").next("span").length===0){$(".icon.in").removeClass("disabled")}if(b.find("span.active").prev("span").length>0){b.find("span.active").removeClass("active").prev("span").addClass("active")}if(b.find("span.active").prev("span").length===0){$(this).addClass("disabled")}galmap.tilesize=parseInt(b.find("span.active").text(),10);game.log("new tilesize",galmap.tilesize);galmap.drawMap(galmap.mapdata);galmap.focusMap(g,f)}}}})},getCoordsFromOffset:function(d,b){var f=$("#mapCanvas");var g=$("#mapViewPort");var e=Math.abs(((g.width()/f.width())*galmap.mapdata.settings.size)/2);var c=parseInt((Math.ceil(Math.abs((d/f.width())*galmap.mapdata.settings.size)+e)-1),10);var a=parseInt((Math.ceil(Math.abs((b/f.height())*galmap.mapdata.settings.size)+e)-1),10);return{x:c,y:a}},getOffSetFromCoords:function(i,g){var a=$("#mapViewPort");var e=Math.round(a.width()/2);var c=Math.round(a.height()/2);var d=Math.round(((i+1)*galmap.tilesize)-(galmap.tilesize/2));var b=Math.round(((g+1)*galmap.tilesize)-(galmap.tilesize/2));var h=e-d;var f=c-b;return{x:h,y:f}},drawSystem:function(g){var c=galmap.mapdata.systems[g].x;var a=galmap.mapdata.systems[g].y;var e=120;var d=(c*galmap.tilesize)+Math.round(galmap.tilesize/2);var b=(a*galmap.tilesize)+Math.round(galmap.tilesize/2);var f=Math.round((galmap.tilesize*4)/5);game.log("drawing system"," id: "+g+", owner: "+galmap.mapdata.systems[g].owner+", spectral: "+galmap.mapdata.systems[g].spectral+", x: "+c+"("+d+"), y: "+a+"("+b+")");$("#mapCanvas").drawImage({source:$("#spriteStars").attr("src"),sWidth:e,sHeight:e,sx:0,sy:(galmap.mapdata.systems[g].spectral*e),cropFromCenter:false,layer:true,clickable:true,name:"system-"+g,groups:["systems"],x:d,y:b,width:f,height:f,fromCenter:true,click:function(){game.log("clicked on star","id: "+g+", owner: "+galmap.mapdata.systems[g].owner+", spectral: "+galmap.mapdata.systems[g].spectral)},mouseover:function(){$(this).css("cursor","pointer")},mouseout:function(){$(this).css("cursor","move")}})},drawWormHole:function(h,g){var a="#9cf";var f=(galmap.mapdata.systems[h].x*galmap.tilesize)+(galmap.tilesize/2);var c=(galmap.mapdata.systems[h].y*galmap.tilesize)+(galmap.tilesize/2);var e=(galmap.mapdata.systems[g].x*galmap.tilesize)+(galmap.tilesize/2);var b=(galmap.mapdata.systems[g].y*galmap.tilesize)+(galmap.tilesize/2);var d=1;if(galmap.bindZoom>1){d=2}game.log("drawing wormhole","from #"+h+" ("+f+","+c+") to #"+g+" ("+e+","+b+")");$("#mapCanvas").drawLine({layer:true,groups:["wormholes"],strokeStyle:a,strokeWidth:d,x1:f,y1:c,x2:e,y2:b})}};galmap.init();