/*!***************************************************************************************
** Project: game v0.0.1 - turn-based space game 
** Author: Sven Scharfenberg (sven.scharfenberg@projektvier.de) 
** Last Changes: 17.11.2013 21:16 
** Homepage: tbd 
** License: GNU General Public License 3.0 (http://www.gnu.org/licenses/gpl-3.0.en.html) 
*****************************************************************************************/

window.galmap=window.galmap||{tilesize:0,mapdata:null,init:function(){if((!Modernizr.canvas)||(!Modernizr.canvastext)){alert("Sorry, your browser does not support canvas or canvastext. Please update your browser");location.href="http://www.google.de/intl/de/chrome/browser/"}var b=$("#mapViewPort"),c=$("#viewPortRulerVert");b.height(b.width()).height(b.width());c.height(b.height());var a=galmap.loadData("./mapdata.json");a.done(function(e){game.log("Data recieved from JSON",e);galmap.mapdata=e;var f=$("#currentZoomMarker"),d;if((Modernizr.localstorage)&&(localStorage["galmap.zoomlevel"])){d=parseInt(f.find("span").length,10)-parseInt(localStorage["galmap.zoomlevel"],10)-1}else{d=Math.ceil(parseInt(f.find("span").length-1,10)/2)}galmap.tilesize=parseInt(f.find("span").eq(d).addClass("active").text(),10);if(f.find("span:first").hasClass("active")){$(".icon.in").addClass("disabled")}if(f.find("span:last").hasClass("active")){$(".icon.out").addClass("disabled")}galmap.drawMap(e);galmap.bindMapDragging();galmap.bindRulerDragging();galmap.bindFocusButton(".mapbutton.focushome",e.systems[e.home].x,e.systems[e.home].y);galmap.bindZoom();$(".overlay.loading").hide();game.log("finished drawing map",0)}).fail(function(d){game.log("faled to recieve data from JSON",d);$(".overlay.jsonfail").show();galmap.bindRefreshButton()})},loadData:function(a){$(".overlay.loading").show();return $.getJSON(a)},drawMap:function(c){var b=$("#mapCanvas");var a=galmap.tilesize*c.settings.size;b.prop({width:a,height:a});b.clearCanvas({x:0,y:0,width:a,height:a}).removeLayers();galmap.drawGrid(c.settings.size);galmap.drawRulers(c.settings.size);game.log("Number of Wormholes",c.wormholes.length);c.wormholes.forEach(function(d){galmap.drawWormHole(d.from,d.to)});game.log("Number of Systems",c.systems.length);c.systems.forEach(function(d){galmap.drawSystem(d.id)})},drawGrid:function(){var g=$("#mapCanvas"),d="#1a1a1a",h=2,c,b,f,e;if(galmap.tilesize<50){h=1}for(var a=0;a<(galmap.mapdata.settings.size-1);a++){c=(galmap.tilesize*a)+galmap.tilesize;b=(galmap.tilesize*a)+galmap.tilesize;f=0;e=g.height();g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:h,x1:c,y1:f,x2:b,y2:e});c=0;b=g.width();f=(galmap.tilesize*a)+galmap.tilesize;e=(galmap.tilesize*a)+galmap.tilesize;g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:h,x1:c,y1:f,x2:b,y2:e})}g.drawLine({layer:true,groups:["grid"],strokeStyle:d,strokeWidth:h,x1:1,y1:1,x2:g.width()-1,y2:1,x3:g.width()-1,y3:g.height()-1,x4:1,y4:g.height()-1,x5:1,y5:1});game.log("finished drawing grid",0)},drawRulers:function(){var f=$("#rulerHorzCanvas"),g=$("#rulerVertCanvas"),n="#fff",m="#1a1a1a",c=galmap.tilesize*galmap.mapdata.settings.size,b,a,k,j,e,d,l;f.prop({width:c});g.prop({height:c});for(var h=0;h<galmap.mapdata.settings.size;h++){l=h.toString();b=Math.round((galmap.tilesize*h)+(galmap.tilesize/2));a=12;k=(galmap.tilesize*h)+galmap.tilesize;e=0;j=(galmap.tilesize*h)+galmap.tilesize;d=f.height();f.drawText({fontSize:12,fontFamily:"Arial",fillStyle:n,x:b,y:a,text:l}).drawLine({strokeStyle:m,strokeWidth:2,x1:k,y1:e,x2:j,y2:d});b=12;a=Math.round((galmap.tilesize*h)+(galmap.tilesize/2));k=0;e=(galmap.tilesize*h)+galmap.tilesize;j=g.width();d=(galmap.tilesize*h)+galmap.tilesize;g.drawText({fontSize:12,fontFamily:"Arial",fillStyle:n,x:b,y:a,text:l}).drawLine({strokeStyle:m,strokeWidth:2,x1:k,y1:e,x2:j,y2:d})}f.drawLine({strokeStyle:m,strokeWidth:2,x1:f.width(),y1:f.height(),x2:0,y2:f.height(),x3:0,y3:0,x4:f.width(),y4:0});g.drawLine({strokeStyle:m,strokeWidth:2,x1:0,y1:g.height(),x2:0,y2:0,x3:g.width(),y3:0,x4:g.width(),y4:g.height()});game.log("finished drawing rulers",0)},bindRefreshButton:function(){var b=$(".overlay.jsonfail"),a=b.find("a.refresh");game.log("refreshbutton",a);$(document).on("click",a,function(c){c.preventDefault();b.hide();game.log("refresh initiated by user",b);galmap.init()})},bindMapDragging:function(){var a=$("#mapCanvas"),b=$("#mapViewPort");a.drag(function(f,c){var e=parseInt(a.prop("width")-b.width(),10),d=parseInt(a.prop("height")-b.height(),10);if(c.offsetY>0){c.offsetY=0}if(c.offsetY<-d){c.offsetY=-d}if(c.offsetX>0){c.offsetX=0}if(c.offsetX<-e){c.offsetX=-e}$(this).css({top:c.offsetY,left:c.offsetX});$("#rulerHorzCanvas").css("left",c.offsetX);$("#rulerVertCanvas").css("top",c.offsetY)},{relative:true}).drag("end",function(){game.log("dragged map","endposition - top: "+$(this).css("top")+", left: "+$(this).css("left"))})},bindRulerDragging:function(){var e=$("#mapCanvas"),f=$("#mapViewPort"),d=$("#rulerHorzCanvas"),c=$("#rulerVertCanvas"),b,a;d.drag(function(h,g){b=parseInt(e.prop("width")-f.width(),10);if(g.offsetX>0){g.offsetX=0}if(g.offsetX<-b){g.offsetX=-b}$(this).css({left:g.offsetX});e.css("left",g.offsetX)},{relative:true}).drag("end",function(){game.log("dragged horizontal ruler","endposition - left: "+d.css("left"))});c.drag(function(h,g){a=parseInt(e.prop("height")-f.height(),10);if(g.offsetY>0){g.offsetY=0}if(g.offsetY<-a){g.offsetY=-a}$(this).css({top:g.offsetY});e.css("top",g.offsetY)},{relative:true}).drag("end",function(){game.log("dragged vertical ruler","endposition -  top: "+c.css("top"))})},bindFocusButton:function(b,c,a){$(document).on("click",b,function(d){d.preventDefault();galmap.focusMap(c,a,"flash")})},focusMap:function(j,h,f){var d=$("#mapViewPort"),a=$("#mapCanvas"),c=galmap.getOffSetFromCoords(j,h),i=c.x,g=c.y,b=parseInt(a.prop("width")-d.width(),10),e=parseInt(a.prop("height")-d.height(),10);if(i<-b){i=-e}if(g<-e){g=-e}if(i>0){i=0}if(g>0){g=0}if(f==="flash"){game.log("moving map and rulers to","x: "+i+", y:"+g+" ("+j+","+h+")");$("#rulerHorzCanvas").animate({left:i},200);$("#rulerVertCanvas").animate({top:g},20);a.animate({left:i,top:g},200,function(){a.removeLayerGroup("flashbg").removeLayerGroup("flashtile");var k="#153b61",l="#9cf";a.drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*j)-1,y:0,width:galmap.tilesize+2,height:(galmap.tilesize*h)}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*j)-1,y:(galmap.tilesize*(h+1)),width:galmap.tilesize+2,height:a.height()-(galmap.tilesize*h)}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:0,y:(galmap.tilesize*h)-1,width:(galmap.tilesize*j),height:galmap.tilesize+2}).drawRect({fillStyle:k,layer:true,groups:["flashbg"],fromCenter:false,x:(galmap.tilesize*(j+1)),y:(galmap.tilesize*h)-1,width:a.width()-(galmap.tilesize*j),height:galmap.tilesize+2}).drawRect({fillStyle:"transparent",strokeStyle:l,strokeWidth:2,layer:true,fromCenter:false,groups:["flashtile"],x:(galmap.tilesize*j),y:(galmap.tilesize*h),width:galmap.tilesize,height:galmap.tilesize});a.animateLayerGroup("flashbg",{fillStyle:"transparent"},1500,"swing",function(m){a.removeLayerGroup(m)});a.animateLayerGroup("flashtile",{strokeStyle:"transparent"},1500,"swing",function(m){a.removeLayerGroup(m)});a.drawLayers()})}else{game.log("snapping map and rulers to","x: "+i+", y:"+g+" ("+j+","+h+")");$("#rulerHorzCanvas").css("left",i);$("#rulerVertCanvas").css("top",g);a.css({left:i,top:g})}},bindZoom:function(){$(document).on("click",".zoom a.icon:not(.disabled)",function(c){c.preventDefault();game.log("Zoom requested",0);var b=$("#currentZoomMarker"),e=$("#mapCanvas"),a=e.position(),d=galmap.getCoordsFromOffset(a.left,a.top),g=d.x,f=d.y;game.log("Coordinates before bindZoom","("+g+","+f+")");if($(this).hasClass("in")){if(b.find("span.active").next("span").length===0){$(".icon.out").removeClass("disabled")}if(b.find("span.active").prev("span").length>0){b.find("span.active").removeClass("active").prev("span").addClass("active")}if(b.find("span.active").prev("span").length===0){$(this).addClass("disabled")}galmap.tilesize=parseInt(b.find("span.active").text(),10);game.log("new tilesize",galmap.tilesize);galmap.drawMap(galmap.mapdata);galmap.focusMap(g,f);localStorage["galmap.zoomlevel"]=parseInt(b.find("span").length,10)-b.find("span.active").index()-1}else{if($(this).hasClass("out")){if(b.find("span.active").prev("span").length===0){$(".icon.in").removeClass("disabled")}if(b.find("span.active").next("span").length>0){b.find("span.active").removeClass("active").next("span").addClass("active")}if(b.find("span.active").next("span").length===0){$(this).addClass("disabled")}galmap.tilesize=parseInt(b.find("span.active").text(),10);game.log("new tilesize",galmap.tilesize);galmap.drawMap(galmap.mapdata);galmap.focusMap(g,f);localStorage["galmap.zoomlevel"]=parseInt(b.find("span").length,10)-b.find("span.active").index()-1}}})},getCoordsFromOffset:function(d,b){var f=$("#mapCanvas"),g=$("#mapViewPort"),e=Math.abs(((g.width()/f.width())*galmap.mapdata.settings.size)/2),c=parseInt((Math.ceil(Math.abs((d/f.width())*galmap.mapdata.settings.size)+e)-1),10),a=parseInt((Math.ceil(Math.abs((b/f.height())*galmap.mapdata.settings.size)+e)-1),10);return{x:c,y:a}},getOffSetFromCoords:function(i,g){var a=$("#mapViewPort"),e=Math.round(a.width()/2),c=Math.round(a.height()/2),d=Math.round(((i+1)*galmap.tilesize)-(galmap.tilesize/2)),b=Math.round(((g+1)*galmap.tilesize)-(galmap.tilesize/2)),h=e-d,f=c-b;return{x:h,y:f}},drawSystem:function(h){var c=galmap.mapdata.systems[h].x,a=galmap.mapdata.systems[h].y,f=$("#mapCanvas"),e=64,d=(c*galmap.tilesize)+Math.round(galmap.tilesize/2),b=(a*galmap.tilesize)+Math.round(galmap.tilesize/2),g=Math.round((galmap.tilesize*4)/5);game.log("drawing system"," id: "+h+", owner: "+galmap.mapdata.systems[h].owner+", spectral: "+galmap.mapdata.systems[h].spectral+", x: "+c+"("+d+"), y: "+a+"("+b+")");f.drawImage({source:$("#spriteStars").prop("src"),sWidth:e,sHeight:e,sx:0,sy:(galmap.mapdata.systems[h].spectral*e),cropFromCenter:false,layer:true,clickable:true,name:"system-"+h,groups:["systems"],x:d,y:b,width:g,height:g,fromCenter:true,mouseover:function(){f.css("cursor","pointer")},mouseout:function(){$(this).css("cursor","move")},click:function(){game.log("clicked on star","id: "+h+", owner: "+galmap.mapdata.systems[h].owner+", spectral: "+galmap.mapdata.systems[h].spectral)}})},drawWormHole:function(g,f){var a="#9cf",e=(galmap.mapdata.systems[g].x*galmap.tilesize)+(galmap.tilesize/2),c=(galmap.mapdata.systems[g].y*galmap.tilesize)+(galmap.tilesize/2),d=(galmap.mapdata.systems[f].x*galmap.tilesize)+(galmap.tilesize/2),b=(galmap.mapdata.systems[f].y*galmap.tilesize)+(galmap.tilesize/2);strokeWidth=1;if(galmap.tilesize>50){strokeWidth=2}game.log("drawing wormhole","from #"+g+" ("+e+","+c+") to #"+f+" ("+d+","+b+")");$("#mapCanvas").drawLine({layer:true,groups:["wormholes"],strokeStyle:a,strokeWidth:strokeWidth,x1:e,y1:c,x2:d,y2:b})}};galmap.init();